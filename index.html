<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Universe Map MVP — Single-File</title>
<!--
Universe Map MVP
Author: ChatGPT (senior WebGL + data-viz engineer profile)
Architecture:
- Single file. ES modules only. No build step. Three.js + OrbitControls via CDN.
- Modules in-page: state, data, math, render, ui, main.
- Scenes: Solar System (meshes, orbits), Local Stars (~100 sample Gaia-like), LSS mock galaxies (~2k points).
- Time: simTime as Julian Date. Play/pause, speed, ±1 day, speed ×1/×10/×100.
- Accuracy: ICRS/J2000; circular Keplerian propagation for planets; star positions from RA/Dec/parallax with simple proper motion.
- Performance: requestAnimationFrame with dynamic throttling; low-power mode halves draw counts and caps to 30 FPS.
- Service Worker: in-page `<script type="text/worker">` compiled to Blob and registered to cache this file and CDN deps.
- Extend datasets: add rows to GAIA_SAMPLE in data module; add planet entries in PLANETS; increase Gx count in LSS generator.

Extending data:
- Stars: push objects with fields {id, name?, ra, dec, parallax_mas, pm_ra, pm_dec, Gmag, Teff}.
- Planets: push objects {name, a_AU, period_days, radius_km, textureDataURL}.
- Moons: add parent field 'around' matching host name and small 'a_AU' etc.

Deploying notes are at the very bottom of this file in an HTML comment.
-->
<style>
:root{
  --bg:#0b0e14; --fg:#e6e6e6; --muted:#9aa0a6; --accent:#7dd3fc; --accent2:#a7f3d0;
  --danger:#fca5a5; --ok:#86efac; --panel:#11151f; --panel2:#0f1320; --focus:#fde047;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.3 system-ui,Segoe UI,Roboto,Arial}
#app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
canvas{display:block;outline:none}
.topbar{
  display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:linear-gradient(#0f1422,#0b0e14);
  border-bottom:1px solid #1f2937;position:relative;z-index:10
}
.topbar h1{font-size:16px;margin:0;color:var(--fg);white-space:nowrap}
.topbar .grow{flex:1}
input,button,select{background:#0e1421;color:var(--fg);border:1px solid #1f2937;border-radius:6px;padding:.4rem .5rem}
button{cursor:pointer}
button[aria-pressed="true"],.btn-on{border-color:var(--accent);box-shadow:0 0 0 1px inset var(--accent)}
button:focus, input:focus, select:focus{outline:2px solid var(--focus);outline-offset:2px}
.group{display:flex;gap:.35rem;align-items:center}
label{color:var(--muted);font-size:12px}
#rightPanel{
  position:fixed;top:40px;right:0;height:calc(100% - 40px);width:320px;max-width:90vw;background:var(--panel);
  border-left:1px solid #1f2937;transform:translateX(0);transition:transform .2s ease;z-index:9;display:flex;flex-direction:column
}
#rightPanel.hidden{transform:translateX(100%)}
#rightPanel header{display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;border-bottom:1px solid #1f2937}
#infoBody{padding:.6rem;overflow:auto}
.kv{display:grid;grid-template-columns:110px 1fr;gap:.25rem .5rem;margin:.4rem 0}
.kv div{min-width:0}
.badge{display:inline-block;padding:.1rem .35rem;border:1px solid #334155;border-radius:999px;font-size:11px;color:var(--accent2)}
#helpBtn{position:fixed;left:.5rem;bottom:.5rem;background:#0e1421;border-color:#334155;z-index:8}
#help{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:20}
#help.show{display:flex}
#help .card{background:var(--panel2);border:1px solid #334155;border-radius:10px;max-width:760px;width:92vw;max-height:80vh;overflow:auto;padding:1rem}
code,kbd{background:#0b1220;border:1px solid #1f2937;border-radius:4px;padding:2px 5px}
.toast{position:fixed;right:.75rem;bottom:3.1rem;background:#101827;border:1px solid #374151;border-radius:8px;padding:.5rem .7rem;color:#e5e7eb;z-index:30;display:none}
.toast.show{display:block}
#metrics{position:fixed;left:.5rem;bottom:3.1rem;color:#9ca3af;background:#0b1220;border:1px solid #1f2937;border-radius:6px;padding:.25rem .4rem;font-size:12px;z-index:5}
#drawerToggle{position:absolute;right:.5rem;top:.35rem}
.mode-btns button{min-width:86px}
@media (max-width: 760px){ .topbar{flex-wrap:wrap} .mode-btns{order:3;width:100%} #rightPanel{top:80px;height:calc(100% - 80px)} }
</style>
</head>
<body>
<div id="app" role="application" aria-label="Universe Map">
  <div class="topbar" role="toolbar" aria-label="Controls">
    <h1>Universe Map MVP</h1>
    <div class="group grow" style="min-width:220px">
      <input id="search" type="search" aria-label="Search by name or ID" placeholder="Search: Sun, Earth, Sirius, HIP 70890…" />
      <button id="copyLink" title="Copy link" aria-label="Copy link">Copy link</button>
    </div>
    <div class="group" aria-label="Time controls">
      <button id="stepBack" title="-1 day" aria-label="Step back one day">−1d</button>
      <button id="playPause" aria-pressed="false" aria-label="Play/Pause">⏵</button>
      <button id="stepFwd" title="+1 day" aria-label="Step forward one day">+1d</button>
      <select id="speed" aria-label="Speed">
        <option value="1">×1</option>
        <option value="10">×10</option>
        <option value="100">×100</option>
        <option value="1000">×1000</option>
      </select>
      <label for="lowPower"><input id="lowPower" type="checkbox" /> Low power</label>
    </div>
    <div class="group mode-btns" role="group" aria-label="Modes">
      <button id="modeSolar">Solar System</button>
      <button id="modeStars">Local Stars</button>
      <button id="modeLSS">LSS</button>
      <button id="resetCam" title="Reset camera">Reset</button>
    </div>
  </div>
  <div id="threewrap" style="position:relative">
    <canvas id="gl" aria-label="3D starfield and solar system canvas"></canvas>
  </div>
</div>

<button id="helpBtn" aria-haspopup="dialog" aria-controls="help" aria-label="Help">Help</button>
<div id="help" role="dialog" aria-modal="true" aria-label="Help and shortcuts">
  <div class="card">
    <h2>Controls</h2>
    <ul>
      <li><kbd>Mouse</kbd>: orbit, pan with right-drag, zoom wheel</li>
      <li><kbd>WASD</kbd> + <kbd>Q/E</kbd>: strafe and vertical pan</li>
      <li><kbd>R</kbd>: reset view. <kbd>F</kbd>: focus selected</li>
      <li><kbd>H</kbd>: toggle this help</li>
      <li>Toolbar time: ⏵ play/pause, ±1 day, speed ×1/×10/×100/×1000</li>
    </ul>
    <p>Data are illustrative. Star colors from Teff. Magnitudes approximate. Orbits circular for MVP.</p>
    <button id="closeHelp">Close</button>
  </div>
</div>

<div id="rightPanel" class="hidden" aria-live="polite" aria-label="Info panel">
  <header><strong id="objTitle">Selection</strong><button id="drawerToggle" aria-label="Hide details">⟲</button></header>
  <div id="infoBody">
    <div class="kv">
      <div><span class="badge">Type</span></div><div id="infoType">—</div>
      <div>Distance</div><div id="infoDist">—</div>
      <div>Magnitude</div><div id="infoMag">—</div>
      <div>Coord</div><div id="infoCoord">—</div>
      <div>ID</div><div id="infoId">—</div>
    </div>
  </div>
</div>

<div id="metrics" aria-live="polite">FPS: — | Draw: —</div>
<div class="toast" id="toast" role="status">Copied link</div>

<!-- External libs via CDN -->
<script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js"></script>
<script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/controls/OrbitControls.js"></script>

<!-- Service Worker definition -->
<script type="text/worker" id="sw-code">
const C_NAME='universe-mvp-v1';
const toCache = self.registration ? [] : []; // placeholder when parsed standalone
self.addEventListener('install', e=>{
  e.waitUntil((async()=>{
    const c=await caches.open(C_NAME);
    const urls=[
      location.href,
      'https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js',
      'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/controls/OrbitControls.js'
    ];
    await c.addAll(urls);
    self.skipWaiting();
  })());
});
self.addEventListener('activate', e=>e.waitUntil(self.clients.claim()));
self.addEventListener('fetch', e=>{
  const req=e.request;
  e.respondWith((async()=>{
    const c=await caches.open(C_NAME);
    const hit=await c.match(req);
    if(hit) return hit;
    try{
      const res=await fetch(req);
      if(req.url.startsWith(location.origin)||req.url.includes('cdn.jsdelivr.net')){
        c.put(req,res.clone());
      }
      return res;
    }catch(err){ return hit || Response.error() }
  })());
});
</script>

<!-- State module -->
<script type="module" id="mod-state">
export const State = {
  mode: 'solar', // 'solar' | 'stars' | 'lss'
  lowPower: false,
  playing: false,
  speed: 1, // days per real second when playing
  simJD: 2451545.0, // J2000.0
  lastRAF: 0,
  throttleMs: 0, // dynamic
  selection: null,
  hashDirty: false,
  camState: {t:[0,0,0], r:[0,0,0,1], d:10},
};
export function updateFromHash(hash){
  try{
    const h = new URLSearchParams(hash.replace(/^#/, ''));
    if(h.get('m')) State.mode = h.get('m');
    if(h.get('lp')) State.lowPower = h.get('lp')==='1';
    if(h.get('jd')) State.simJD = parseFloat(h.get('jd'));
    if(h.get('cam')){
      State.camState = JSON.parse(atob(h.get('cam')));
    }
  }catch{}
}
export function makeHash(cam){
  const p = new URLSearchParams();
  p.set('m',State.mode);
  p.set('lp',State.lowPower?'1':'0');
  p.set('jd',State.simJD.toFixed(3));
  const camState = {
    t:[cam.target.x,cam.target.y,cam.target.z],
    p:[cam.object.position.x,cam.object.position.y,cam.object.position.z]
  };
  p.set('cam', btoa(JSON.stringify(camState)));
  return '#'+p.toString();
}
</script>

<!-- Data module -->
<script type="module" id="mod-data">
/* Minimal data to run offline */
export const AU = 149597870.7; // km
export const PLANETS = [
  // Circular approx at J2000: a_AU, sidereal period (days), radius (km)
  {name:'Mercury', a_AU:0.387, period_days:87.969, radius_km:2440},
  {name:'Venus'  , a_AU:0.723, period_days:224.701, radius_km:6052},
  {name:'Earth'  , a_AU:1.000, period_days:365.256, radius_km:6371},
  {name:'Mars'   , a_AU:1.524, period_days:686.980, radius_km:3390},
  {name:'Jupiter', a_AU:5.203, period_days:4332.59, radius_km:69911},
  {name:'Saturn' , a_AU:9.537, period_days:10759.22, radius_km:58232},
  {name:'Uranus' , a_AU:19.191,period_days:30685.4, radius_km:25362},
  {name:'Neptune', a_AU:30.07, period_days:60189.0, radius_km:24622},
];
export const MOONS = [
  {name:'Moon', around:'Earth', a_AU:0.00257, period_days:27.321, radius_km:1737},
  {name:'Io', around:'Jupiter', a_AU:0.00282, period_days:1.769, radius_km:1822},
  {name:'Europa', around:'Jupiter', a_AU:0.00449, period_days:3.551, radius_km:1561},
  {name:'Ganymede', around:'Jupiter', a_AU:0.00716, period_days:7.155, radius_km:2634},
  {name:'Callisto', around:'Jupiter', a_AU:0.0126, period_days:16.689, radius_km:2410},
  {name:'Titan', around:'Saturn', a_AU:0.00817, period_days:15.945, radius_km:2575},
  {name:'Rhea', around:'Saturn', a_AU:0.00352, period_days:4.518, radius_km:764},
  {name:'Triton', around:'Neptune', a_AU:0.00237, period_days:5.877, radius_km:1353},
];
export const NAMED_STARS = [
  'Sirius','Canopus','Arcturus','Vega','Capella','Rigel','Procyon','Achernar','Betelgeuse','Hadar','Altair','Aldebaran'
];

/* 100-sample Gaia-like subset (plausible values). Units: deg, mas, mag, K. */
export const GAIA_SAMPLE = [
  {"id":"Sirius","name":"Sirius","ra":101.2875,"dec":-16.7161,"parallax_mas":379.21,"pm_ra":-546.01,"pm_dec":-1223.07,"Gmag":-1.46,"Teff":9940},
  {"id":"Canopus","name":"Canopus","ra":95.9879,"dec":-52.6957,"parallax_mas":10.55,"pm_ra":19.93,"pm_dec":23.24,"Gmag":-0.74,"Teff":7350},
  {"id":"Arcturus","name":"Arcturus","ra":213.9153,"dec":19.1824,"parallax_mas":88.83,"pm_ra":-1093.43,"pm_dec":-1999.43,"Gmag":-0.05,"Teff":4286},
  {"id":"Vega","name":"Vega","ra":279.2347,"dec":38.7837,"parallax_mas":130.23,"pm_ra":200.94,"pm_dec":286.23,"Gmag":0.03,"Teff":9602},
  {"id":"Capella","name":"Capella","ra":79.1723,"dec":45.9979,"parallax_mas":76.20,"pm_ra":75.52,"pm_dec":-427.12,"Gmag":0.08,"Teff":4970},
  {"id":"Rigel","name":"Rigel","ra":78.6345,"dec":-8.2016,"parallax_mas":3.78,"pm_ra":1.87,"pm_dec":0.56,"Gmag":0.18,"Teff":11000},
  {"id":"Procyon","name":"Procyon","ra":114.8255,"dec":5.2250,"parallax_mas":284.56,"pm_ra":-716.57,"pm_dec":-1036.84,"Gmag":0.38,"Teff":6530},
  {"id":"Achernar","name":"Achernar","ra":24.4286,"dec":-57.2367,"parallax_mas":22.68,"pm_ra":88.02,"pm_dec":-40.08,"Gmag":0.46,"Teff":15000},
  {"id":"Betelgeuse","name":"Betelgeuse","ra":88.7929,"dec":7.4071,"parallax_mas":5.95,"pm_ra":27.33,"pm_dec":10.86,"Gmag":0.50,"Teff":3500},
  {"id":"Altair","name":"Altair","ra":297.6958,"dec":8.8683,"parallax_mas":194.44,"pm_ra":536.82,"pm_dec":385.47,"Gmag":0.77,"Teff":7550},
  {"id":"Aldebaran","name":"Aldebaran","ra":68.9802,"dec":16.5093,"parallax_mas":50.09,"pm_ra":62.78,"pm_dec":-189.36,"Gmag":0.85,"Teff":3900},
  {"id":"Hadar","name":"Hadar","ra":210.9558,"dec":-60.3730,"parallax_mas":7.15,"pm_ra":-33.99,"pm_dec":-25.06,"Gmag":0.61,"Teff":24000},
  {"id":"HIP 70890","ra":217.4289,"dec":-62.6795,"parallax_mas":771.64,"pm_ra":-3775.75,"pm_dec":770.54,"Gmag":11.13,"Teff":3000},
  {"id":"Barnard","name":"Barnard's Star","ra":269.4520,"dec":4.6934,"parallax_mas":548.31,"pm_ra":-802.33,"pm_dec":10362.53,"Gmag":9.5,"Teff":3134},
  {"id":"Wolf 359","ra":162.2588,"dec":7.0091,"parallax_mas":419.10,"pm_ra":-384.0,"pm_dec":-2707.0,"Gmag":13.5,"Teff":2800},
  {"id":"Luyten 726-8","ra":24.7073,"dec":-17.9559,"parallax_mas":373.70,"pm_ra":3297.0,"pm_dec":563.0,"Gmag":12.6,"Teff":2800},
  {"id":"Sirius B","ra":101.2875,"dec":-16.7161,"parallax_mas":379.21,"pm_ra":-546.01,"pm_dec":-1223.07,"Gmag":8.44,"Teff":25200},
  {"id":"Proxima","name":"Proxima Centauri","ra":217.4292,"dec":-62.6795,"parallax_mas":768.50,"pm_ra":-3775.0,"pm_dec":770.5,"Gmag":11.13,"Teff":3042},
  {"id":"Alpha Cen A","ra":219.9021,"dec":-60.8339,"parallax_mas":747.17,"pm_ra":-3679.25,"pm_dec":473.67,"Gmag":0.01,"Teff":5790},
  {"id":"Alpha Cen B","ra":219.9141,"dec":-60.8350,"parallax_mas":747.17,"pm_ra":-3600.0,"pm_dec":500.0,"Gmag":1.35,"Teff":5260}
];
// Fill up to ~100 with mock faint stars around random sky positions
for(let i=GAIA_SAMPLE.length;i<100;i++){
  const ra=Math.random()*360, dec=(Math.random()*180-90);
  const plx=2+Math.random()*50; // 20 to 500 pc
  const pmra=(Math.random()*4-2)*50, pmdec=(Math.random()*4-2)*50;
  const mag=4+Math.random()*8, teff=3000+Math.random()*9000;
  GAIA_SAMPLE.push({id:`G${i}`,ra,dec,parallax_mas:plx,pm_ra:pmra,pm_dec:pmdec,Gmag:mag,Teff:teff});
}

/* Low-res textures as tiny data-URIs */
function solid(color){ // 64x64 PNG
  const c=document.createElement('canvas'); c.width=c.height=64;
  const g=c.getContext('2d'); g.fillStyle=color; g.fillRect(0,0,64,64);
  return c.toDataURL('image/png');
}
export const TEX = {
  sun: solid('#ffd27a'),
  planet: solid('#9bb1ff'),
  earth: solid('#3a9bdc'),
  mars: solid('#c1440e'),
  jupiter: solid('#d8c7a6'),
  saturn: solid('#cdbb8e'),
  uranus: solid('#94e0e8'),
  neptune: solid('#6b8ddd'),
  moon: solid('#cfcfcf'),
};
/* Low-res Milky Way background as gradient data URL */
export const BG_DATAURL = (()=>solid('#000015'))();
</script>

<!-- Math and conversions -->
<script type="module" id="mod-math">
export const DEG2RAD = Math.PI/180, RAD2DEG=180/Math.PI, DAY=86400;
export function clamp(v,a,b){return Math.min(b,Math.max(a,v))}
export function jdNowUTC(){ return (Date.now()/1000/86400)+2440587.5 } // approx
export function advanceJD(jd, days){ return jd+days }
export function keplerCircularPos(a_AU, period_days, jd, phase0=0){
  const M = ((jd-2451545.0)/period_days*2*Math.PI + phase0)%(2*Math.PI);
  const x = a_AU*Math.cos(M), y = 0, z = a_AU*Math.sin(M);
  return [x,y,z]; // AU in ecliptic-like plane
}
export function raDecPlxToXYZ(ra,dec,plx_mas){
  const d_pc = plx_mas>0 ? 1000.0/plx_mas : 1e6;
  const r = d_pc; // use pc units
  const a=ra*DEG2RAD, d=dec*DEG2RAD;
  const x = r*Math.cos(d)*Math.cos(a);
  const y = r*Math.cos(d)*Math.sin(a);
  const z = r*Math.sin(d);
  return [x,y,z, d_pc];
}
export function properMotion(ra,dec,pm_ra,pm_dec, years){
  // crude: shift in degrees (pm in mas/yr), ignoring cos(dec) factor nuances
  const dra = pm_ra/1000/3600; // arcsec/yr -> deg/yr
  const ddec= pm_dec/1000/3600;
  return [ra + dra*years, dec + ddec*years];
}
export function teffToRGB(T){
  // Simple approximation piecewise
  // returns [r,g,b] 0..1
  T = clamp(T,1000,40000)/100;
  let r,g,b;
  // red
  r = T<=66 ? 1 : clamp(1.292936186062745*(Math.pow(T-60,-0.1332047592)),0,1);
  // green
  g = T<=66 ? clamp(0.3900815787690196*Math.log(T)-0.6318414437886275,0,1) :
      clamp(1.129890860895294*(Math.pow(T-60,-0.0755148492)),0,1);
  // blue
  b = T>=66 ? 1 : (T<=19 ? 0 : clamp(0.543206789110196*Math.log(T-10)-1.19625408914,0,1));
  return [r,g,b];
}
</script>

<!-- Render module -->
<script type="module" id="mod-render">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js';
import {OrbitControls} from 'https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/controls/OrbitControls.js';
import {State, makeHash} from './index.html#mod-state';
import {PLANETS,MOONS,TEX,BG_DATAURL} from './index.html#mod-data';
import {keplerCircularPos, teffToRGB, DEG2RAD} from './index.html#mod-math';

export const Render = {};
const W = Render;

W.init = (canvas)=>{
  const gl2 = canvas.getContext('webgl2');
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true, powerPreference:'high-performance'});
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.setSize(innerWidth, innerHeight-40, false);

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x02030a);

  // Background sphere with basic texture
  const bgTex = new THREE.TextureLoader().load(BG_DATAURL);
  bgTex.colorSpace = THREE.SRGBColorSpace;
  const bgGeo = new THREE.SphereGeometry(100000, 16, 12);
  const bgMat = new THREE.MeshBasicMaterial({map:bgTex, side:THREE.BackSide});
  const bgMesh = new THREE.Mesh(bgGeo,bgMat);
  scene.add(bgMesh);

  const camera = new THREE.PerspectiveCamera(60, canvas.clientWidth/canvas.clientHeight, 1e-3, 1e9);
  camera.position.set(0, 5, 12);

  const controls = new OrbitControls(camera, canvas);
  controls.enableDamping = true; controls.dampingFactor = 0.05; controls.enablePan = true;
  controls.addEventListener('change', ()=>{ State.hashDirty=true });

  const grid = new THREE.GridHelper(20, 20, 0x223, 0x223); grid.material.opacity=0.15; grid.material.transparent=true;
  scene.add(grid);

  // Sun
  const sunGeo = new THREE.SphereGeometry(0.3, 24, 16);
  const sunMat = new THREE.MeshBasicMaterial({map:new THREE.TextureLoader().load(TEX.sun)});
  const sun = new THREE.Mesh(sunGeo, sunMat);
  sun.name='Sun'; scene.add(sun);

  // Sun halo as sprite
  const haloMat = new THREE.SpriteMaterial({color:0xfff0b0, transparent:true, opacity:0.5});
  const halo = new THREE.Sprite(haloMat); halo.scale.set(2,2,1); sun.add(halo);

  // Planets
  const planetGroup = new THREE.Group(); planetGroup.name='Planets'; scene.add(planetGroup);
  const planetMats = {
    Mercury: TEX.planet, Venus:TEX.planet, Earth:TEX.earth, Mars:TEX.mars, Jupiter:TEX.jupiter, Saturn:TEX.saturn, Uranus:TEX.uranus, Neptune:TEX.neptune
  };
  const pMeshes = {};
  for(const p of PLANETS){
    const geo = new THREE.SphereGeometry(Math.cbrt(p.radius_km)/100, 24, 16);
    const tex = new THREE.TextureLoader().load(planetMats[p.name]||TEX.planet); tex.colorSpace=THREE.SRGBColorSpace;
    const mat = new THREE.MeshStandardMaterial({map:tex, metalness:0, roughness:1, emissive:0x000000});
    const mesh = new THREE.Mesh(geo, mat); mesh.userData={type:'planet', data:p, name:p.name};
    mesh.name=p.name;
    planetGroup.add(mesh); pMeshes[p.name]=mesh;
  }
  // Simple light for planets
  const l1 = new THREE.PointLight(0xffffff, 2.0, 0, 2); l1.position.set(0,0,0); scene.add(l1);
  const amb = new THREE.AmbientLight(0x404050, 0.5); scene.add(amb);

  // Moons
  const moonGroup = new THREE.Group(); moonGroup.name='Moons'; scene.add(moonGroup);
  const moonTex = new THREE.TextureLoader().load(TEX.moon); moonTex.colorSpace=THREE.SRGBColorSpace;
  for(const m of MOONS){
    const geo = new THREE.SphereGeometry(Math.cbrt(m.radius_km)/300, 18, 12);
    const mat = new THREE.MeshStandardMaterial({map:moonTex, roughness:1});
    const mesh = new THREE.Mesh(geo, mat); mesh.userData={type:'moon', data:m, name:m.name};
    mesh.name=m.name; moonGroup.add(mesh);
  }

  // Orbits and AU ruler
  const orbitGroup = new THREE.Group(); scene.add(orbitGroup);
  function addOrbit(radius){
    const N=256; const pts=[];
    for(let i=0;i<=N;i++){ const a=i/N*2*Math.PI; pts.push(new THREE.Vector3(radius*Math.cos(a),0,radius*Math.sin(a)))}
    const geo=new THREE.BufferGeometry().setFromPoints(pts);
    const mat=new THREE.LineBasicMaterial({color:0x224466, transparent:true, opacity:0.35});
    return new THREE.Line(geo,mat);
  }
  PLANETS.forEach(p=>orbitGroup.add(addOrbit(p.a_AU)));
  // AU ticks 0..35
  const tickGeo = new THREE.BufferGeometry(); const tickVerts=[];
  for(let au=0; au<=35; au++){
    tickVerts.push(au,-0.02,0, au,0.02,0);
  }
  tickGeo.setAttribute('position', new THREE.Float32BufferAttribute(tickVerts,3));
  const tick = new THREE.LineSegments(tickGeo, new THREE.LineBasicMaterial({color:0x446688, opacity:0.5, transparent:true}));
  scene.add(tick);

  // Stars points container
  const starGroup = new THREE.Group(); starGroup.name='Stars'; starGroup.visible=false; scene.add(starGroup);
  let starPoints=null, starGeo=null, starMat=null, starData=null;

  // LSS mock galaxies
  const lssGroup = new THREE.Group(); lssGroup.visible=false; scene.add(lssGroup);
  let lssPoints=null;

  // Raycaster for picking
  const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();

  function resize(){
    const w=innerWidth, h=innerHeight-40;
    renderer.setSize(w,h,false);
    camera.aspect=w/h; camera.updateProjectionMatrix();
  }
  addEventListener('resize', resize);

  function buildStars(data, fraction=1){
    if(starPoints){ starGroup.remove(starPoints); starPoints.geometry.dispose(); starPoints.material.dispose(); starPoints=null; }
    const n = Math.max(1,Math.floor(data.length*fraction));
    starData = data.slice(0,n);
    const pos = new Float32Array(n*3);
    const col = new Float32Array(n*3);
    const siz = new Float32Array(n);
    for(let i=0;i<n;i++){
      const s=starData[i];
      const [r,g,b]=teffToRGB(s.Teff||6000);
      const plx = s.parallax_mas>0?s.parallax_mas:1;
      const d_pc = 1000/plx;
      const a=s.ra*DEG2RAD, d=s.dec*DEG2RAD;
      const x=d_pc*Math.cos(d)*Math.cos(a);
      const y=d_pc*Math.cos(d)*Math.sin(a);
      const z=d_pc*Math.sin(d);
      pos[i*3]=x; pos[i*3+1]=z; pos[i*3+2]=y; // simple axis swap for nicer view
      col[i*3]=r; col[i*3+1]=g; col[i*3+2]=b;
      const app = s.Gmag ?? 6;
      siz[i]= Math.max(1.5, 8 - 0.8*app);
    }
    starGeo = new THREE.BufferGeometry();
    starGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
    starGeo.setAttribute('color', new THREE.BufferAttribute(col,3));
    starGeo.setAttribute('size', new THREE.BufferAttribute(siz,1));
    const vtx = `
      attribute float size;
      varying vec3 vColor;
      void main(){
        vColor = color;
        vec4 mvPosition = modelViewMatrix * vec4(position,1.0);
        gl_PointSize = size * (300.0 / -mvPosition.z);
        gl_Position = projectionMatrix * mvPosition;
      }`;
    const frag = `
      varying vec3 vColor;
      void main(){
        float d = length(gl_PointCoord-vec2(0.5));
        float a = smoothstep(0.5,0.0,d);
        gl_FragColor = vec4(vColor, a);
      }`;
    starMat = new THREE.ShaderMaterial({
      vertexColors:true, transparent:true, depthWrite:false,
      uniforms:{}, vertexShader:vtx, fragmentShader:frag
    });
    starPoints = new THREE.Points(starGeo, starMat);
    starPoints.userData={type:'stars'};
    starGroup.add(starPoints);
  }

  function buildLSS(count=2000){
    if(lssPoints){ lssGroup.remove(lssPoints); lssPoints.geometry.dispose(); lssPoints.material.dispose(); lssPoints=null; }
    const pos = new Float32Array(count*3);
    for(let i=0;i<count;i++){
      const x=(Math.random()*2-1)*2000;
      const y=(Math.random()*2-1)*2000;
      const z=(Math.random()*2-1)*2000;
      pos.set([x,y,z], i*3);
    }
    const geo = new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
    const mat = new THREE.PointsMaterial({size:2, sizeAttenuation:true, color:0x99bbff});
    lssPoints = new THREE.Points(geo,mat);
    lssPoints.userData={type:'lss'};
    lssGroup.add(lssPoints);
  }

  function setMode(mode){
    State.mode=mode;
    const s = mode==='solar';
    planetGroup.visible=s; moonGroup.visible=s; orbitGroup.visible=s; grid.visible=s; tick.visible=s;
    starGroup.visible = mode==='stars';
    lssGroup.visible = mode==='lss';
    document.getElementById('modeSolar').classList.toggle('btn-on', s);
    document.getElementById('modeStars').classList.toggle('btn-on', mode==='stars');
    document.getElementById('modeLSS').classList.toggle('btn-on', mode==='lss');
    State.hashDirty=true;
  }

  function updateSolar(jd){
    // planets
    for(const p of PLANETS){
      const [x,y,z]=keplerCircularPos(p.a_AU, p.period_days, jd);
      const m=pMeshes[p.name]; if(!m) continue;
      m.position.set(x,y,z);
    }
    // moons
    for(const m of moonGroup.children){
      const d = m.userData.data;
      const host = pMeshes[d.around]; if(!host) continue;
      const [x,y,z]=keplerCircularPos(d.a_AU, d.period_days, jd, (host.name==='Moon')?Math.PI:0);
      m.position.copy(host.position).add(new THREE.Vector3(x,y,z));
    }
  }

  function pick(evt){
    const rect=renderer.domElement.getBoundingClientRect();
    mouse.x=((evt.clientX-rect.left)/rect.width)*2-1;
    mouse.y=-((evt.clientY-rect.top)/rect.height)*2+1;
    raycaster.setFromCamera(mouse, camera);
    // Try planets and moons
    const objs=[...planetGroup.children, ...moonGroup.children];
    let res=raycaster.intersectObjects(objs, true)[0];
    if(!res && (State.mode==='stars' || State.mode==='lss') && starPoints){
      // nearest star to ray
      const pos=starGeo.getAttribute('position'); let best=null, bestD=1e9, idx=-1;
      const v=new THREE.Vector3();
      for(let i=0;i<pos.count;i+=1){
        v.set(pos.getX(i),pos.getY(i),pos.getZ(i));
        const d=raycaster.ray.distanceToPoint(v);
        if(d<bestD){bestD=d; idx=i; best=v.clone();}
      }
      if(idx>=0 && bestD<50){ // coarse threshold
        res = {object:starPoints, point:best, index:idx};
      }
    }
    if(res){
      let info=null;
      if(res.object.userData?.type==='stars'){
        const s = starData[res.index];
        info = {name:s.name||s.id||'Star', type:'Star', id:s.id||'—', coord:`RA ${s.ra.toFixed(2)}° Dec ${s.dec.toFixed(2)}°`,
                mag:(s.Gmag??0).toFixed(2), dist:`${(1000/(s.parallax_mas||1)).toFixed(1)} pc`};
      }else{
        const u = res.object.userData;
        const typ=u?.type==='moon'?'Moon':'Planet';
        const name=u?.name||res.object.name;
        const id=name;
        const pos=res.object.position;
        const dist = pos.length().toFixed(3)+' AU';
        info = {name, type:typ, id, coord:`x ${pos.x.toFixed(3)} y ${pos.y.toFixed(3)} z ${pos.z.toFixed(3)} AU`,
                mag:'—', dist};
      }
      showInfo(info);
      State.selection = info;
    }
  }

  function showInfo(info){
    const rp=document.getElementById('rightPanel');
    document.getElementById('objTitle').textContent=info.name||'Selection';
    document.getElementById('infoType').textContent=info.type||'—';
    document.getElementById('infoId').textContent=info.id||'—';
    document.getElementById('infoCoord').textContent=info.coord||'—';
    document.getElementById('infoMag').textContent=info.mag||'—';
    document.getElementById('infoDist').textContent=info.dist||'—';
    rp.classList.remove('hidden');
  }

  canvas.addEventListener('click', pick);

  function animate(ts){
    const dt = (W.prevTs? (ts-W.prevTs):16.6); W.prevTs=ts;
    const targetMs = State.lowPower? 1000/30 : 1000/60;
    const over = dt - targetMs;
    // dynamic throttle: if last frame exceeded target, skip next update step
    if(over>4){ W.skipNext = true } else { W.skipNext=false }
    if(!W.skipNext){
      if(State.playing){
        State.simJD += (State.speed || 1)*(dt/1000);
      }
      updateSolar(State.simJD);
      controls.update();
      renderer.render(scene,camera);
    }
    // metrics
    W.frameCount=(W.frameCount||0)+1; W.timeAcc=(W.timeAcc||0)+dt;
    if(W.timeAcc>5000){
      const fps = (W.frameCount*1000/W.timeAcc).toFixed(1);
      const draws = renderer.info.render.calls;
      document.getElementById('metrics').textContent=`FPS: ${fps} | Draw: ${draws}`;
      console.log('Metrics',{fps,draws,gpu:renderer.capabilities.getMaxAnisotropy(),renderer:renderer.info});
      W.frameCount=0; W.timeAcc=0;
    }
    if(State.hashDirty){
      history.replaceState(null,'', makeHash(controls));
      State.hashDirty=false;
    }
    W.rafId = requestAnimationFrame(animate);
  }

  function resetCam(){
    camera.position.set(0,5,12); controls.target.set(0,0,0); controls.update(); State.hashDirty=true;
  }

  function focusSelection(){
    if(!State.selection) return;
    const s = State.selection;
    // crude: fly to object based on dist value unit
    const m = /([\d\.\-]+)\s*(pc|AU)/.exec(s.dist||'');
    let d = m? parseFloat(m[1]) : 5;
    if(m && m[2]==='pc'){ d*=0.05 } // scale down for display
    const dir = new THREE.Vector3(0,0,d);
    camera.position.copy(dir); controls.target.set(0,0,0); controls.update(); State.hashDirty=true;
  }

  // Public
  W.scene=scene; W.camera=camera; W.controls=controls; W.renderer=renderer;
  W.setMode=setMode; W.buildStars=buildStars; W.buildLSS=buildLSS;
  W.resetCam=resetCam; W.focusSelection=focusSelection;

  resize(); animate(0);
  return W;
};
</script>

<!-- UI module -->
<script type="module" id="mod-ui">
import {State, updateFromHash} from './index.html#mod-state';
import {GAIA_SAMPLE,NAMED_STARS} from './index.html#mod-data';
import {Render} from './index.html#mod-render';
import {jdNowUTC} from './index.html#mod-math';

function $(q){return document.querySelector(q)}
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500) }

export async function initUI(){
  updateFromHash(location.hash||'');
  const canvas = document.getElementById('gl');
  const R = Render.init(canvas);

  // Build datasets
  R.buildStars(GAIA_SAMPLE, State.lowPower?0.5:1);
  R.buildLSS(State.lowPower?1000:2000);
  R.setMode(State.mode);

  // Service worker register
  try{
    if('serviceWorker' in navigator){
      const code = document.getElementById('sw-code').textContent;
      const blob = new Blob([code], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(url, {scope:'./'});
      console.log('SW registered');
    }
  }catch(e){ console.warn('SW failed',e) }

  // Controls
  const playBtn = $('#playPause');
  const stepB = $('#stepBack'), stepF = $('#stepFwd'), speedSel = $('#speed');
  const lowPower = $('#lowPower');
  const modeSolar = $('#modeSolar'), modeStars=$('#modeStars'), modeLSS=$('#modeLSS');
  const reset = $('#resetCam');
  const search = $('#search');
  const copyLink = $('#copyLink');

  // initial
  if(!location.hash){ State.simJD = Math.floor(jdNowUTC()); }
  playBtn.setAttribute('aria-pressed', String(State.playing));
  speedSel.value= String(State.speed);

  playBtn.addEventListener('click',()=>{
    State.playing=!State.playing;
    playBtn.textContent = State.playing?'⏸':'⏵';
    playBtn.setAttribute('aria-pressed', String(State.playing));
  });
  stepB.addEventListener('click',()=>{ State.simJD-=1; State.hashDirty=true });
  stepF.addEventListener('click',()=>{ State.simJD+=1; State.hashDirty=true });
  speedSel.addEventListener('change',()=>{ State.speed=parseFloat(speedSel.value)||1 });

  lowPower.addEventListener('change',()=>{
    State.lowPower=lowPower.checked;
    R.buildStars(GAIA_SAMPLE, State.lowPower?0.5:1);
    R.buildLSS(State.lowPower?1000:2000);
    State.hashDirty=true;
  });

  modeSolar.addEventListener('click',()=>R.setMode('solar'));
  modeStars.addEventListener('click',()=>R.setMode('stars'));
  modeLSS.addEventListener('click',()=>R.setMode('lss'));
  reset.addEventListener('click',()=>R.resetCam());

  // Search + fuzzy match
  function fuzzy(q, s){ q=q.toLowerCase(); s=String(s||'').toLowerCase(); return s.includes(q) }
  function searchAll(q){
    const hits=[];
    // planets and moons
    for(const o of R.scene.getObjectByName('Planets').children){
      if(fuzzy(q,o.name)) hits.push({name:o.name, type:'Planet', id:o.name, focus:()=>R.controls.target.copy(o.position)});
    }
    for(const o of R.scene.getObjectByName('Moons').children){
      if(fuzzy(q,o.name)) hits.push({name:o.name, type:'Moon', id:o.name, focus:()=>R.controls.target.copy(o.position)});
    }
    // stars
    for(const s of GAIA_SAMPLE){
      if(fuzzy(q,s.name||s.id)||fuzzy(q,s.id)) hits.push({name:s.name||s.id, type:'Star', id:s.id, focus:()=>{}});
    }
    return hits;
  }
  search.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){
      const q=search.value.trim(); if(!q){ return }
      const hits=searchAll(q);
      if(hits.length){
        const h=hits[0];
        if(h.type==='Star'){
          R.setMode('stars');
          // Focus by moving camera toward approximate location
          // Here we simply set selection info and call focusSelection
          const s = GAIA_SAMPLE.find(s=> (s.name||s.id)===h.name);
          if(s){
            const dist = (1000/(s.parallax_mas||1));
            const info = {name:s.name||s.id, type:'Star', id:s.id||'—', coord:`RA ${s.ra.toFixed(2)}° Dec ${s.dec.toFixed(2)}°`,
              mag:(s.Gmag??0).toFixed(2), dist:`${dist.toFixed(1)} pc`};
            // show panel and focus
            document.getElementById('objTitle').textContent=info.name;
            document.getElementById('infoType').textContent=info.type;
            document.getElementById('infoId').textContent=info.id;
            document.getElementById('infoCoord').textContent=info.coord;
            document.getElementById('infoMag').textContent=info.mag;
            document.getElementById('infoDist').textContent=info.dist;
            document.getElementById('rightPanel').classList.remove('hidden');
            // Move camera roughly
            const d = Math.min(50, Math.max(5, dist*0.05));
            R.camera.position.set(d,d,d); R.controls.target.set(0,0,0); R.controls.update();
            State.selection = info;
          }
        }else{
          R.setMode('solar');
          const obj = R.scene.getObjectByName(h.name);
          if(obj){
            R.controls.target.copy(obj.position);
            R.camera.position.copy(obj.position.clone().addScalar(2));
            R.controls.update();
            State.selection={name:h.name,type:h.type,id:h.id,coord:'—',mag:'—',dist:`${obj.position.length().toFixed(3)} AU`};
          }
        }
      }else{
        toast('No results');
      }
    }
  });

  copyLink.addEventListener('click', async ()=>{
    State.hashDirty=true; // force refresh now
    history.replaceState(null,'', location.pathname + location.hash);
    try{ await navigator.clipboard.writeText(location.href); toast('Link copied'); }catch(e){ toast('Copy failed') }
  });

  // Drawer toggles
  const drawer = document.getElementById('rightPanel');
  document.getElementById('drawerToggle').addEventListener('click',()=>drawer.classList.toggle('hidden'));

  // Help
  const helpBtn = document.getElementById('helpBtn');
  const help = document.getElementById('help'); const closeHelp = document.getElementById('closeHelp');
  function toggleHelp(){ help.classList.toggle('show') }
  helpBtn.addEventListener('click', toggleHelp);
  closeHelp.addEventListener('click', toggleHelp);
  addEventListener('keydown', (e)=>{
    if(e.key==='h' || e.key==='H') toggleHelp();
    if(e.key==='r' || e.key==='R') R.resetCam();
    if(e.key==='f' || e.key==='F') R.focusSelection();
    if(e.key===' ') { State.playing=!State.playing; playBtn.textContent= State.playing?'⏸':'⏵' }
    // WASDQE pans
    const s=0.2;
    if(['w','a','s','d','q','e','W','A','S','D','Q','E'].includes(e.key)){
      const k=e.key.toLowerCase();
      const c=R.controls; const cam=R.camera;
      const v=new THREE.Vector3();
      if(k==='w') cam.getWorldDirection(v).multiplyScalar(s), cam.position.add(v), c.target.add(v);
      if(k==='s') cam.getWorldDirection(v).multiplyScalar(-s), cam.position.add(v), c.target.add(v);
      if(k==='a'){ cam.getWorldDirection(v).cross(cam.up).multiplyScalar(-s); cam.position.add(v); c.target.add(v); }
      if(k==='d'){ cam.getWorldDirection(v).cross(cam.up).multiplyScalar(s); cam.position.add(v); c.target.add(v); }
      if(k==='q'){ v.set(0,-s,0); cam.position.add(v); c.target.add(v); }
      if(k==='e'){ v.set(0,s,0); cam.position.add(v); c.target.add(v); }
      c.update(); State.hashDirty=true;
    }
  });

  // Restore from hash after init
  addEventListener('hashchange', ()=>{ /* no-op; state writes hash */ });

  // Accessibility focus outlines already enabled
}
</script>

<!-- Main entry -->
<!-- Main entry: inline-module bootstrap for GitHub Pages -->
<script type="module">
  // Build blob URLs for each inline module
  const modIds = ['mod-state','mod-data','mod-math','mod-render','mod-ui'];
  const urls = {};
  for (const id of modIds) {
    const code = document.getElementById(id).textContent;
    urls[id] = URL.createObjectURL(new Blob([code], { type: 'text/javascript' }));
  }

  // Install an import map that points our specifiers to those blobs
  const imap = {
    imports: {
      './index.html#mod-state': urls['mod-state'],
      './index.html#mod-data':  urls['mod-data'],
      './index.html#mod-math':  urls['mod-math'],
      './index.html#mod-render':urls['mod-render'],
      './index.html#mod-ui':    urls['mod-ui']
    }
  };
  const s = document.createElement('script');
  s.type = 'importmap';
  s.textContent = JSON.stringify(imap);
  document.currentScript.after(s);

  // Now import UI and start
  import('./index.html#mod-ui').then(({initUI}) => initUI()).catch(err => {
    console.error(err);
    const t = document.getElementById('toast');
    t.textContent = 'Error: ' + err.message;
    t.classList.add('show');
  });
</script>

</body>
</html>
